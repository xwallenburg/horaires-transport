<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs – Arc-en-Ciel & Zinguerie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

  <style>
      body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }

      .stop-header {
          font-size: 12px;
          font-weight: bold;
          margin-top: 40px;
          margin-bottom: 5px;
      }

      table {
          border-collapse: collapse;
          width: 100%;
          max-width: 600px;
          margin-bottom: 40px;
      }

      td, th {
          padding: 8px;
          border-bottom: 1px solid #ddd;
          text-align: center;
          font-size: 12px;
      }

      .delay { color: red; }

      .line-badge {
          display: inline-block;
          padding: 4px 10px;
          border-radius: 20px;
          color: white;
          font-weight: bold;
          font-size: 12px;
      }

      .L17 { background: #0082CA; }
      .L36 { background: #00A859; }
      .L54 { background: #E86E0A; }
      .L58 { background: #C2185B; }
  </style>
</head>

<body>

<p class="stop-header">Arc-en-Ciel – Ligne 17 → Lausanne, Vigie</p>
<table>
  <thead>
    <tr>
      <th>Ligne</th>
      <th>Destination</th>
      <th>Heure</th>
      <th>Dans</th>
      <th>Retard</th>
    </tr>
  </thead>
  <tbody id="ace"></tbody>
</table>

<p class="stop-header">Zinguerie → Renens</p>
<table>
  <thead>
    <tr>
      <th>Ligne</th>
      <th>Destination</th>
      <th>Heure</th>
      <th>Dans</th>
      <th>Retard</th>
    </tr>
  </thead>
  <tbody id="zing"></tbody>
</table>

<script>

function parseDate(dateStr) {
    if (!dateStr || dateStr === "nodata") return null;
    return moment(dateStr, "DD.MM.YYYY HH:mm");
}

function fetchStop(stopId, callback) {
    $.getJSON(
        "https://api3.geo.admin.ch/stationboard/stops/" + stopId + "?_=" + Date.now(),
        callback
    ).fail(() => callback(null));
}

function formatEntry(entry) {
    const now = moment();

    const scheduled = parseDate(entry.departureDate);
    const estimated = parseDate(entry.estimatedDate);
    const finalTime = estimated || scheduled;

    if (!finalTime || !finalTime.isValid()) return "";

    let delay = "";
    if (estimated && scheduled) {
        const late = estimated.diff(scheduled, "minutes");
        if (late > 0) delay = "(+" + late + "′)";
    }

    const diff = Math.max(0, Math.floor(finalTime.diff(now, "minutes"))) + "′";
    const line = (entry.label || "").trim();

    return `
        <tr>
            <td><span class="line-badge L${line}">${line}</span></td>
            <td>${entry.destinationName}</td>
            <td>${finalTime.format("HH:mm")}</td>
            <td>${diff}</td>
            <td class="delay">${delay}</td>
        </tr>
    `;
}

function loadAll() {

    /* ARC-EN-CIEL */
    fetchStop(8591935, data => {
        let rows = "";
        if (data) {
            data.forEach(e => {
                const line = (e.label || "").trim();
                const dest = (e.destinationName || "").toLowerCase();

                if (line !== "17") return;
                if (!dest.includes("vigie")) return;

                rows += formatEntry(e);
            });
        }
        $("#ace").html(rows || "<tr><td colspan='5'>Aucun départ</td></tr>");
    });

    /* ZINGUERIE */
    fetchStop(8591939, data => {
        let rows = "";
        if (data) {
            data.forEach(e => {
                const line = (e.label || "").trim();
                const dest = (e.destinationName || "").toLowerCase();

                if (!["36","54","58"].includes(line)) return;
                if (!dest.includes("renens")) return;

                rows += formatEntry(e);
            });
        }
        $("#zing").html(rows || "<tr><td colspan='5'>Aucun départ</td></tr>");
    });
}

loadAll();
setInterval(loadAll, 60000);

</script>

</body>
</html>
